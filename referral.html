<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="description" content="Join the Aetheron Referral Program. Earn up to 25% rewards by referring friends. Get real-time stats and track your earnings.">
    <meta name="keywords" content="Aetheron, referral program, cryptocurrency, AETH token, Polygon, earn rewards, defi">
    <meta name="author" content="Aetheron Platform">
    <meta name="theme-color" content="#00D4FF">
    
    <!-- Open Graph / Social Meta -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://aetheron.online/referral.html">
    <meta property="og:title" content="Aetheron Referral Program - Earn Rewards">
    <meta property="og:description" content="Join 10000+ members earning rewards. Generate your unique referral link and start earning AETH tokens today.">
    <meta property="og:image" content="https://aetheron.online/logo-512x512.png">
    <meta property="og:site_name" content="Aetheron Platform">
    
    <!-- Twitter / X Meta -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://aetheron.online/referral.html">
    <meta property="twitter:title" content="Aetheron Referral Program - Earn Rewards">
    <meta property="twitter:description" content="Earn up to 25% rewards by referring friends to Aetheron. Join our referral program today.">
    <meta property="twitter:image" content="https://aetheron.online/logo-512x512.png">
    <meta property="twitter:creator" content="@AetherionCrypto">
    
    <!-- Canonical & Mobile -->
    <link rel="canonical" href="https://aetheron.online/referral.html">
    <link rel="alternate" hreflang="en" href="https://aetheron.online/referral.html">
    
    <title>Aetheron Referral Program - Earn Rewards</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://polygon-rpc.com">
    <link rel="stylesheet" href="shared-mobile-polish.css?v=1.3.0">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00D4FF;
            --secondary: #8A2BE2;
            --accent: #FF6B35;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0a0a0a;
            --light: #1a1a2e;
            --text: #ffffff;
            --card-bg: rgba(26, 26, 46, 0.8);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: var(--text);
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-btn {
            display: inline-block;
            margin-bottom: 2rem;
            padding: 0.75rem 1.5rem;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--primary);
            border-radius: 12px;
            color: var(--text);
            text-decoration: none;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            transform: translateX(-5px);
        }

        .hero {
            text-align: center;
            margin-bottom: 4rem;
        }

        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .card-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .referral-code-box {
            background: rgba(0, 212, 255, 0.1);
            border: 2px dashed var(--primary);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
        }

        .referral-link {
            font-size: 1.2rem;
            font-family: monospace;
            color: var(--primary);
            margin: 1rem 0;
            word-break: break-all;
        }

        .copy-btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.4);
        }

        .copy-btn.copied {
            background: var(--success);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
        }

        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .benefit-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s;
        }

        .benefit-card:hover {
            background: rgba(0, 212, 255, 0.1);
            transform: translateY(-5px);
        }

        .benefit-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .benefit-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .benefit-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .referral-list {
            list-style: none;
        }

        .referral-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .referral-item:last-child {
            border-bottom: none;
        }

        .referral-address {
            font-family: monospace;
            color: var(--primary);
        }

        .referral-reward {
            color: var(--success);
            font-weight: 600;
        }

        .wallet-connect-box {
            text-align: center;
            padding: 3rem;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 12px;
            border: 1px solid var(--accent);
        }

        .wallet-connect-box button {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--accent), var(--danger));
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .referral-item {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>

        <div class="hero">
            <h1><i class="fas fa-share-alt"></i> Referral Program</h1>
            <p>Earn 5% of your friends' first stake in AETH tokens!</p>
        </div>

        <div id="walletConnectPrompt" class="card">
            <div class="wallet-connect-box">
                <i class="fas fa-wallet" style="font-size: 4rem; color: var(--accent); margin-bottom: 1rem;"></i>
                <h2>Connect Your Wallet</h2>
                <p style="margin: 1rem 0; color: rgba(255, 255, 255, 0.7);">Connect your wallet to generate your unique referral link and track your rewards</p>
                <button onclick="connectWallet()">
                    <i class="fas fa-wallet"></i> Connect Wallet
                </button>
            </div>
        </div>

        <div id="referralContent" style="display: none;">
            <!-- Your Referral Link -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-link"></i>
                        Your Referral Link
                    </h2>
                </div>
                
                <div class="referral-code-box">
                    <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 1rem;">Share this link with your friends:</p>
                    <div class="referral-link" id="referralLink">
                        https://mastatrill.github.io/Aetheron_platform/?ref=0x...
                    </div>
                    <button class="copy-btn" onclick="copyReferralLink(this)">
                        <i class="fas fa-copy"></i>
                        <span id="copyBtnText">Copy Link</span>
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-bar"></i>
                        Your Stats
                    </h2>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="totalReferrals">0</div>
                        <div class="stat-label">Total Referrals</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="activeReferrals">0</div>
                        <div class="stat-label">Active Stakers</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="totalEarned">0 AETH</div>
                        <div class="stat-label">Total Earned</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="pendingRewards">0 AETH</div>
                        <div class="stat-label">Pending Rewards</div>
                    </div>
                </div>
            </div>

            <!-- How It Works -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-question-circle"></i>
                        How It Works
                    </h2>
                </div>

                <div class="benefits-grid">
                    <div class="benefit-card">
                        <div class="benefit-icon">1Ô∏è‚É£</div>
                        <div class="benefit-title">Share Your Link</div>
                        <div class="benefit-desc">Copy your unique referral link and share it with friends</div>
                    </div>

                    <div class="benefit-card">
                        <div class="benefit-icon">2Ô∏è‚É£</div>
                        <div class="benefit-title">They Stake AETH</div>
                        <div class="benefit-desc">When they stake tokens for the first time using your link</div>
                    </div>

                    <div class="benefit-card">
                        <div class="benefit-icon">3Ô∏è‚É£</div>
                        <div class="benefit-title">You Earn 5%</div>
                        <div class="benefit-desc">Receive 5% of their initial stake amount in AETH</div>
                    </div>

                    <div class="benefit-card">
                        <div class="benefit-icon">üéÅ</div>
                        <div class="benefit-title">Bonus Rewards</div>
                        <div class="benefit-desc">Extra bonuses for top referrers each month!</div>
                    </div>
                </div>
            </div>

            <!-- Your Referrals -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-users"></i>
                        Your Referrals
                    </h2>
                </div>

                <ul class="referral-list" id="referralsList">
                    <li style="text-align: center; padding: 2rem; color: rgba(255, 255, 255, 0.5);">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                        No referrals yet. Start sharing your link!
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let provider, signer, account;
        
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask to use this feature!');
                return;
            }

            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                account = await signer.getAddress();

                // Show referral content
                document.getElementById('walletConnectPrompt').style.display = 'none';
                document.getElementById('referralContent').style.display = 'block';

                // Generate referral link
                const referralLink = `https://mastatrill.github.io/Aetheron_platform/?ref=${account}`;
                document.getElementById('referralLink').textContent = referralLink;

                // Load referral stats (mock data for now)
                loadReferralStats();
            } catch (error) {
                console.error('Error connecting wallet:', error);
                alert('Failed to connect wallet. Please try again.');
            }
        }

        function loadReferralStats() {
            // Load real referral stats from localStorage + tracking data
            const userAddress = account.toLowerCase();
            
            // Fetch referral tracking data
            let referralData = {
                totalReferrals: 0,
                activeReferrals: 0,
                totalEarned: 0,
                pendingRewards: 0,
                referrals: []
            };

            try {
                // Load from localStorage
                const storedData = localStorage.getItem(`aeth_referral_${userAddress}`);
                if (storedData) {
                    const parsed = JSON.parse(storedData);
                    referralData = { ...referralData, ...parsed };
                }

                // Optionally query on-chain referral data (if contract supports it)
                queryOnChainReferrals(userAddress).then(onChainStats => {
                    if (onChainStats) {
                        // Merge on-chain data with localStorage
                        referralData.totalReferrals = Math.max(referralData.totalReferrals, onChainStats.totalReferrals || 0);
                        referralData.activeReferrals = Math.max(referralData.activeReferrals, onChainStats.activeReferrals || 0);
                        referralData.totalEarned = Math.max(referralData.totalEarned, onChainStats.totalEarned || 0);
                        referralData.pendingRewards = onChainStats.pendingRewards || referralData.pendingRewards;
                        updateReferralDisplay(referralData);
                    }
                }).catch(err => {
                    console.log('On-chain referral query not available:', err);
                    updateReferralDisplay(referralData);
                });

                // Display localStorage data immediately
                updateReferralDisplay(referralData);
            } catch (error) {
                console.error('Error loading referral stats:', error);
                updateReferralDisplay(referralData);
            }
        }

        function updateReferralDisplay(stats) {
            document.getElementById('totalReferrals').textContent = stats.totalReferrals;
            document.getElementById('activeReferrals').textContent = stats.activeReferrals;
            document.getElementById('totalEarned').textContent = `${stats.totalEarned.toLocaleString()} AETH`;
            document.getElementById('pendingRewards').textContent = `${stats.pendingRewards.toLocaleString()} AETH`;

            // Update referrals list
            const referralsList = document.getElementById('referralsList');
            if (stats.referrals && stats.referrals.length > 0) {
                referralsList.innerHTML = stats.referrals.map(ref => `
                    <li class="referral-item">
                        <span class="referral-address">${formatAddress(ref.address)}</span>
                        <span class="referral-reward">+${ref.reward.toLocaleString()} AETH</span>
                    </li>
                `).join('');
            } else {
                referralsList.innerHTML = '<p style="color: rgba(255,255,255,0.5);">No referrals yet. Share your link to get started!</p>';
            }
        }

        // Format address helper
        function formatAddress(addr) {
            if (addr.length < 10) return addr;
            return `${addr.slice(0, 6)}...${addr.slice(-4)}`;
        }

        // Query on-chain referral data (if contract supports it)
        async function queryOnChainReferrals(userAddress) {
            try {
                const provider = new ethers.providers.JsonRpcProvider('https://polygon-rpc.com');
                const CONTRACT_ADDRESS = '0x072091F554df794852E0A9d1c809F2B2bBda171E';
                
                // Minimal ABI check for referral functions
                const ABI = [
                    'function getReferralStats(address referrer) view returns (uint256 total, uint256 active, uint256 earned, uint256 pending)',
                    'function getReferrals(address referrer) view returns (address[] referrals)'
                ];

                const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
                
                try {
                    const stats = await contract.getReferralStats(userAddress);
                    return {
                        totalReferrals: stats.total.toNumber(),
                        activeReferrals: stats.active.toNumber(),
                        totalEarned: parseFloat(ethers.utils.formatEther(stats.earned)),
                        pendingRewards: parseFloat(ethers.utils.formatEther(stats.pending))
                    };
                } catch {
                    // Contract doesn't support referral functions - return null to use localStorage only
                    return null;
                }
            } catch (error) {
                console.log('On-chain referral query failed:', error.message);
                return null;
            }
        }

        function copyReferralLink(buttonEl) {
            const linkText = document.getElementById('referralLink').textContent;
            navigator.clipboard.writeText(linkText).then(() => {
                const btn = buttonEl || document.querySelector('.copy-btn');
                const btnText = document.getElementById('copyBtnText');
                
                btn.classList.add('copied');
                btnText.textContent = 'Copied!';
                btn.querySelector('i').className = 'fas fa-check';

                // Track copy event
                trackReferralEvent('link_copied', {
                    address: account,
                    timestamp: new Date().toISOString()
                });

                setTimeout(() => {
                    btn.classList.remove('copied');
                    btnText.textContent = 'Copy Link';
                    btn.querySelector('i').className = 'fas fa-copy';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy link. Please try again.');
            });
        }

        // Track referral events in localStorage
        function trackReferralEvent(eventType, data) {
            try {
                const events = JSON.parse(localStorage.getItem('aeth_referral_events') || '[]');
                events.push({
                    type: eventType,
                    ...data,
                    timestamp: new Date().toISOString()
                });
                // Keep only last 100 events
                if (events.length > 100) {
                    events.shift();
                }
                localStorage.setItem('aeth_referral_events', JSON.stringify(events));
            } catch (e) {
                console.warn('Failed to track event:', e);
            }
        }

        // Track referral click and increment referrer's count with caps
        function trackReferralClick(referrerAddress) {
            try {
                const MAX_REWARD_PER_REFERRAL = 2500; // Hard cap on AETH per referral
                
                const referrerKey = `aeth_referral_${referrerAddress.toLowerCase()}`;
                const referralData = JSON.parse(localStorage.getItem(referrerKey) || '{"totalReferrals":0,"activeReferrals":0,"totalEarned":0,"pendingRewards":0,"referrals":[]}');
                
                // Increment referral count
                referralData.totalReferrals = (referralData.totalReferrals || 0) + 1;
                referralData.activeReferrals = (referralData.activeReferrals || 0) + 1;
                
                // Apply reward cap
                const baseReward = 100; // Base reward per referral
                const cappedReward = Math.min(baseReward, MAX_REWARD_PER_REFERRAL);
                referralData.totalEarned = (referralData.totalEarned || 0) + cappedReward;
                
                referralData.lastUpdated = new Date().toISOString();
                
                // Add referral entry with visitor info
                const visitingAddress = localStorage.getItem('aeth_user_address') || 'anonymous';
                referralData.referrals.push({
                    address: visitingAddress,
                    reward: cappedReward,
                    timestamp: new Date().toISOString()
                });

                localStorage.setItem(referrerKey, JSON.stringify(referralData));
                console.log(`‚úì Referral tracked: ${referrerAddress} (+${cappedReward} AETH, capped at ${MAX_REWARD_PER_REFERRAL})`);
                
                trackReferralEvent('referral_click', {
                    referrer: referrerAddress,
                    visitor: visitingAddress,
                    reward: cappedReward
                });
            } catch (e) {
                console.warn('Failed to track referral click:', e);
            }
        }

        // Check URL for referral parameter
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const referrer = urlParams.get('ref');
            
            if (referrer && ethers.utils.isAddress(referrer)) {
                // Valid referrer found - track the click
                console.log('Referral link detected:', referrer);
                trackReferralClick(referrer.toLowerCase());
                
                // Store referrer in localStorage for future transactions
                localStorage.setItem('aeth_referrer', referrer.toLowerCase());
                
                // Show referral banner
                showReferralBanner(referrer);
                
                // Clean URL (remove ref param for aesthetics)
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            }
        });

        function showReferralBanner(referrerAddress) {
            // Create notification banner
            const banner = document.createElement('div');
            banner.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: linear-gradient(135deg, #00D4FF, #667eea);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,212,255,0.3);
                z-index: 9999;
                font-size: 0.9em;
                max-width: 400px;
            `;
            banner.innerHTML = `
                <strong>‚ú® You were referred by:</strong><br>
                ${formatAddress(referrerAddress)}<br>
                <small style="opacity: 0.9;">Earning benefits enabled</small>
            `;
            document.body.appendChild(banner);
            
            // Auto-remove after 8 seconds
            setTimeout(() => banner.remove(), 8000);
        }
    </script>
    <script src="global-announcements.js"></script>
</body>
</html>

